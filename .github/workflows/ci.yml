name: Language Translation API CI/CD Pipeline

on:
  push:
    branches:
      - main
      - dev
      - 'feature/**'
  pull_request:
    branches:
      - main
      - dev
      - 'feature/**'

jobs:
  # Stage 1: Build
  build:
    name: Build and Setup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check Python syntax
        run: |
          python -m py_compile app/main.py
          python -m py_compile app/core/config.py
          python -m py_compile app/services/translator.py
          python -m py_compile app/models/db.py
      
      - name: Verify installation
        run: |
          python --version
          pip list

  # Stage 2: Test
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run pytest
        run: |
          pytest app/tests/ -v --tb=short
      
      - name: Test summary
        if: always()
        run: |
          echo "Tests completed. Check results above."

  # Stage 3: Coverage
  coverage:
    name: Code Coverage Analysis
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests with coverage
        run: |
          pytest app/tests/ --cov=app --cov-report=xml --cov-report=html --cov-report=term-missing --cov-fail-under=75
      
      - name: Generate coverage report
        if: always()
        run: |
          coverage report > coverage-report.txt
          cat coverage-report.txt
      
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: |
            coverage-report.txt
            coverage.xml
            htmlcov/
          retention-days: 30
      
      - name: Check coverage threshold
        run: |
          COVERAGE=$(coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
          echo "Total coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 75" | bc -l) )); then
            echo "Coverage is below 75% threshold"
            exit 1
          fi

  # Stage 4: Lint
  lint:
    name: Code Quality - Pylint
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run pylint
        run: |
          pylint app/ --rcfile=.pylintrc --output-format=text | tee pylint-report.txt
          PYLINT_SCORE=$(sed -n 's/^Your code has been rated at \([-0-9.]*\)\/.*/\1/p' pylint-report.txt)
          echo "Pylint score: $PYLINT_SCORE"
          echo "PYLINT_SCORE=$PYLINT_SCORE" >> $GITHUB_ENV
      
      - name: Check pylint threshold
        run: |
          if (( $(echo "$PYLINT_SCORE < 7.5" | bc -l) )); then
            echo "Pylint score $PYLINT_SCORE is below 7.5 threshold"
            exit 1
          fi
          echo "Pylint score $PYLINT_SCORE meets the threshold"
      
      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: pylint-report
          path: pylint-report.txt
          retention-days: 30

  # Stage 5: Security Scan
  security:
    name: Security Scan - Bandit
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Bandit security scan
        run: |
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/ -f txt -o bandit-report.txt || true
          cat bandit-report.txt
      
      - name: Check for HIGH severity issues
        run: |
          HIGH_ISSUES=$(grep -c "Severity: High" bandit-report.txt || true)
          echo "High severity issues found: $HIGH_ISSUES"
          if [ "$HIGH_ISSUES" -gt 0 ]; then
            echo "Pipeline failed: HIGH severity security issues detected"
            exit 1
          fi
          echo "No HIGH severity issues found"
      
      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: bandit-report
          path: |
            bandit-report.json
            bandit-report.txt
          retention-days: 30

  # Stage 6: Deploy/Artifact Creation
  deploy:
    name: Create Deployment Package
    runs-on: ubuntu-latest
    needs: [test, coverage, lint, security]
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download all artifacts
        uses: actions/download-artifact@v3
      
      - name: Create reports directory
        run: |
          mkdir -p reports
          cp -r coverage-report/* reports/ 2>/dev/null || true
          cp pylint-report/pylint-report.txt reports/ 2>/dev/null || true
          cp bandit-report/bandit-report.* reports/ 2>/dev/null || true
      
      - name: Create deployment package
        run: |
          DATE=$(date +%Y%m%d-%H%M%S)
          PACKAGE_NAME="deployment-package-$DATE.zip"
          echo "Creating package: $PACKAGE_NAME"
          
          # Create package with code and reports
          zip -r $PACKAGE_NAME \
            app/ \
            requirements.txt \
            Dockerfile \
            docker-compose.yml \
            .env.example \
            pytest.ini \
            .pylintrc \
            README.md \
            reports/ \
            -x "*.pyc" "*.pyo" "*__pycache__*" "*.git*"
          
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
          ls -lh $PACKAGE_NAME
      
      - name: Upload deployment package
        uses: actions/upload-artifact@v3
        with:
          name: deployment-package
          path: deployment-package-*.zip
          retention-days: 90
      
      - name: Deployment summary
        run: |
          echo "## Deployment Package Created Successfully! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** $PACKAGE_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pipeline Stages Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Test" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Coverage (â‰¥75%)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Lint (â‰¥7.5)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deployment Package" >> $GITHUB_STEP_SUMMARY
